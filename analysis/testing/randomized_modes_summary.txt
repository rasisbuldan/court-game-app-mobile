================================================================================
RANDOMIZED_MODES MATCHUP PREFERENCE - COMPREHENSIVE ANALYSIS SUMMARY
================================================================================

DOCUMENTS CREATED:
1. /tmp/randomized_modes_analysis.md - Complete implementation analysis
2. /tmp/randomized_modes_code_reference.md - Full code snippets and examples
3. This summary document

================================================================================
KEY FINDINGS
================================================================================

1. IMPLEMENTATION OVERVIEW
   - Located in: mexicano-algorithm.ts (lines 921-953 for main logic)
   - Method: getRandomizedMode(players) - selects mode per match
   - Modes: "mixed" (2x weight), "mens", "womens"
   - Selection: Weighted random from available valid modes

2. WEIGHTED SELECTION (2X FOR MIXED)
   Implementation:
   - modes.push("mixed", "mixed") // Adds twice for 2x weight
   - modes.push("mens") // Adds once
   - modes.push("womens") // Adds once
   - Random selection: Math.floor(Math.random() * modes.length)
   
   Examples:
   - 4M + 2F: ["mixed","mixed","mens"] = 67% mixed, 33% mens
   - 2M + 4F: ["mixed","mixed","womens"] = 67% mixed, 33% womens
   - 4M + 4F: ["mixed","mixed","mens","womens"] = 50% mixed, 25% each other

3. VALIDATION HELPERS
   canCreateMixedDoubles():
   - Requires: 2+ males AND 2+ females
   - Filters: Only counts players with explicit gender (male/female)
   - Ignores: Players with unspecified gender
   
   canCreateSameGenderTeams(gender):
   - Requires: 4+ players of that specific gender
   - Filters: Only counts explicit gender matches
   - Returns: boolean

4. MODE SELECTION PER ROUND/COURT
   - Selection happens in findBestPairing() when matchupPreference="randomized_modes"
   - Called for EACH match independently (per court in sequential mode)
   - Not locked across round (different courts can get different modes)
   - Returns to standard pairing if selected mode fails

5. FALLBACK MECHANISM
   If selected mode can't create valid pairing:
   Step 1: Log warning about mode failure
   Step 2: Check for simple scenarios (2M+2F, 4 same gender)
   Step 3: Fall back to standard pairing
   Step 4: Last resort: fixed pairing [0,2] vs [1,3]

================================================================================
EDGE CASES & TESTING PRIORITIES
================================================================================

CRITICAL TEST CASES:

1. INSUFFICIENT PLAYERS FOR MODE
   Scenario: 3M+3F, "mens" selected (need 4 males)
   Expected: Fallback to mixed or standard pairing
   Verification: Warning logged, valid match created

2. ALL SAME GENDER
   Scenario: 8M + 0F
   Expected: modes = ["mens"] → always select mens
   Verification: Only male matches generated

3. UNSPECIFIED GENDERS
   Scenario: All players gender="unspecified"
   Expected: No gender modes possible → return "any"
   Verification: Falls back to standard pairing

4. UNBALANCED RATIOS
   Scenario: 2M + 6F
   Expected: modes = ["mixed","mixed","womens"] → 67% mixed, 33% womens
   Verification: Gender combinations remain valid

5. EDGE THRESHOLDS
   Scenario: Exactly 4M + 2F
   Expected: modes = ["mixed","mixed","mens"] → both modes available
   Verification: Both modes can be selected and create valid matches

6. MULTIPLE COURTS
   Scenario: 12 players, 2 courts, randomized_modes
   Expected: Each court gets independent mode selection
   Verification: Court 1 might get mixed, Court 2 might get mens

7. MULTI-ROUND CONSISTENCY
   Scenario: 10 rounds with randomized_modes
   Expected: Mode selection varies per round (not locked)
   Verification: Different modes appear across rounds

================================================================================
INTEGRATION POINTS
================================================================================

WORKS WITH:
- Mexicano algorithm (default pairing strategy)
- Americano algorithm (opponent history tracking)
- Sequential court mode (all courts assigned once)
- Parallel court mode (individual court generation)

CONFLICTS WITH:
- Fixed Partner mode (if partners are opposite genders)
  Solution: Fixed Partner takes priority, overrides mode selection

DOES NOT WORK WITH:
- mixed_only matchupPreference (exclusive mode is different)
- Game type "mixed_mexicano" (enforces mixed_only automatically)

================================================================================
CODE LOCATIONS - QUICK REFERENCE
================================================================================

Main Method:
  getRandomizedMode() - L921-953 - Mode selection logic

Validation:
  canCreateMixedDoubles() - L799-819 - Check 2+ M and 2+ F
  canCreateSameGenderTeams() - L824-846 - Check 4+ of gender

Pairing:
  createMixedPairing() - L851-916 - 1M+1F vs 1M+1F teams
  findBestPairingFromPlayers() - L958-1021 - Standard pairing
  findBestPairing() - L1023-1130 - Main dispatcher

Mode Application:
  Lines 1064-1098 - Decision tree for applying selected mode

Tests:
  Constructor test - Line 103
  Basic test (3M+3F) - Line 571
  Odd ratio test (3M+1F) - Line 591
  Female majority test (6F+2M) - Line 605

Test Fixtures:
  createMixedGenderPlayers() - Test data factory
  createPlayers() - Basic player factory

================================================================================
TEST COVERAGE GAPS
================================================================================

Current tests only verify:
- Constructor accepts randomized_modes
- Match structure is valid (no crashes)
- Gender combinations remain valid for 6F+2M case

Missing comprehensive tests for:
1. Weighted selection distribution
2. Mode selection fallback logic
3. Validation boundary conditions
4. Edge cases with unspecified genders
5. Multi-round consistency
6. Parallel court mode integration
7. Performance with many rounds
8. Partnership history tracking across modes
9. Fairness maintenance across mode changes
10. Player statistics accuracy

================================================================================
RECOMMENDATIONS FOR TEST SUITE
================================================================================

Priority 1 (CRITICAL):
- Weighted selection distribution test
- Mode fallback mechanism test
- All same gender edge cases
- Unspecified gender handling

Priority 2 (IMPORTANT):
- Boundary condition tests
- Multi-round consistency
- Integration with other game types
- Partnership history tracking

Priority 3 (NICE-TO-HAVE):
- Performance/stress tests
- Statistical validation of randomness
- Edge cases with mixed court scenarios

================================================================================
HOW TO WRITE TESTS
================================================================================

Use existing test pattern:
1. Create player pool with createMixedGenderPlayers(males, females)
2. Instantiate MexicanoAlgorithm with matchupPreference='randomized_modes'
3. Generate rounds with algo.generateRound(roundNumber)
4. Validate match structure and gender combinations
5. Check for expected modes or fallbacks

Helper functions available:
- clonePlayers() - Deep copy players
- createPlayersWithRatings() - Create with specific ratings
- createFixedPartnerPairs() - Create fixed partner setup

Test data factory patterns already established in test-data.ts

================================================================================
QUICK START FOR WRITING TESTS
================================================================================

Pattern 1 - Basic Mode Selection:
```typescript
const players = createMixedGenderPlayers(4, 4);
const algo = new MexicanoAlgorithm(players, 1, true, 'randomized_modes');
const round = algo.generateRound(1);
expect(round.matches[0].team1).toHaveLength(2);
```

Pattern 2 - Gender Validation:
```typescript
const team1Males = match.team1.filter(p => p.gender === "male").length;
const team2Males = match.team2.filter(p => p.gender === "male").length;
const isMixed = team1Males === 1 && team2Males === 1;
expect(isMixed || otherValidCondition).toBe(true);
```

Pattern 3 - Multiple Rounds:
```typescript
for (let i = 1; i <= 5; i++) {
  const round = algo.generateRound(i);
  // Validate each round
}
```

Pattern 4 - Mode Tracking (would require adding logging):
```typescript
// Current implementation doesn't expose selected mode
// Would need to add spy/mock on getRandomizedMode()
```

================================================================================
FILES ANALYZED
================================================================================

Source Code:
- /packages/mobile/node_modules/@courtster/shared/lib/mexicano-algorithm.ts
  (2133 lines, core algorithm implementation)

Tests:
- __tests__/mexicano-algorithm.test.ts (existing tests)
- __tests__/mexicano-algorithm-extended.test.ts (extended tests)

Test Fixtures:
- __tests__/fixtures/test-data.ts (test factories)
- __tests__/fixtures/test-helpers.ts (validation helpers)

================================================================================
DOCUMENTATION DELIVERED
================================================================================

1. randomized_modes_analysis.md (this document)
   - Overview of feature
   - Implementation details
   - Edge cases and requirements
   - Integration points
   - Test coverage analysis
   - Recommended test suite

2. randomized_modes_code_reference.md
   - Quick reference table
   - Full code snippets
   - Test data factories
   - Existing test examples
   - Mode selection flow diagram
   - Weight distribution examples
   - Error handling patterns
   - Helper methods reference

3. This summary (quick reference)
   - Key findings
   - Test priorities
   - Code locations
   - Quick start guide

================================================================================
NEXT STEPS
================================================================================

1. Use these documents to write comprehensive test suite
2. Focus first on Priority 1 tests (weighted selection, fallback, edge cases)
3. Leverage existing test patterns (3M+3F, 6F+2M tests)
4. Use test factories (createMixedGenderPlayers, createPlayers)
5. Reference code snippets for validation patterns

All code snippets are production-ready and extracted from actual implementation.

